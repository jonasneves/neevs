---
import Layout from '../layouts/Layout.astro';
import ReportCard from '../components/ReportCard.astro';
import { Icon } from 'astro-icon/components';
import fs from 'fs';
import path from 'path';

// Load weekly digest artifacts
let academicArtifacts = [];

try {
  // Load the latest digest
  const digestPath = path.join(process.cwd(), 'public', 'academic-research-digest.json');
  const digestContent = fs.readFileSync(digestPath, 'utf-8');
  const digestData = JSON.parse(digestContent);
  const digest = digestData.data.digest;

  // Extract digest date from timestamp (format: YYYY-MM-DD)
  const digestDate = digestData.timestamp ? digestData.timestamp.split('T')[0] : null;
  const formattedDate = digestDate
    ? new Date(digestDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
    : new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

  // Count total papers in digest
  const totalPapers = digest.sections?.reduce((sum: number, section: any) =>
    sum + (section.papers?.length || 0), 0) || 0;

  // Create a card for the latest weekly digest
  academicArtifacts = [
    {
      title: digest.title || "Weekly Research Roundup",
      description: digest.subtitle || "Engaging weekly digest of trending research papers with social buzz tracking and editorial analysis.",
      href: "/artifacts/research-roundup", // Latest digest always loads from /academic-research-digest.json
      icon: "lucide:newspaper",
      status: "active" as const,
      lastUpdated: formattedDate,
      agents: `${totalPapers} papers`,
    },
  ];

  // Try to load archived digests from public/digests/
  try {
    const digestsDir = path.join(process.cwd(), 'public', 'digests');
    if (fs.existsSync(digestsDir)) {
      const digestFiles = fs.readdirSync(digestsDir)
        .filter(file => file.endsWith('.json') && file.startsWith('academic-research-'))
        .sort()
        .reverse(); // Most recent first

      // Track unique dates to avoid showing multiple digests from the same day
      const seenDates = new Set<string>();
      // Add the latest digest date to seen dates
      if (digestDate) {
        seenDates.add(digestDate);
      }

      for (const file of digestFiles) {
        // Stop after 5 unique dates
        if (seenDates.size >= 6) break; // 6 because we already have the latest (1 + 5 archives)

        const archiveTimestamp = file.replace('.json', '');
        const archivePath = path.join(digestsDir, file);
        const archiveContent = fs.readFileSync(archivePath, 'utf-8');
        const archiveData = JSON.parse(archiveContent);

        // Extract date part from timestamp (academic-research-YYYY-MM-DD-HHMMSS -> YYYY-MM-DD)
        const timestampPart = archiveTimestamp.replace('academic-research-', '');
        const dateParts = timestampPart.split('-');
        const archiveDatePart = dateParts.slice(0, 3).join('-'); // YYYY-MM-DD

        // Skip if we've already shown a digest from this date
        if (seenDates.has(archiveDatePart)) {
          continue;
        }

        const archiveDigest = archiveData.data.digest;
        const archiveFormattedDate = new Date(archiveDatePart).toLocaleDateString('en-US', {
          month: 'short', day: 'numeric', year: 'numeric'
        });

        const archiveTotalPapers = archiveDigest.sections?.reduce((sum: number, section: any) =>
          sum + (section.papers?.length || 0), 0) || 0;

        academicArtifacts.push({
          title: archiveDigest.title || "Weekly Research Roundup",
          description: archiveDigest.subtitle || "Weekly digest of trending research papers",
          href: `/artifacts/research-roundup?timestamp=${archiveTimestamp}`,
          icon: "lucide:newspaper",
          status: "completed" as const,
          lastUpdated: archiveFormattedDate,
          agents: `${archiveTotalPapers} papers`,
        });

        // Mark this date as seen
        seenDates.add(archiveDatePart);
      }
    }
  } catch (archiveError) {
    console.log('No archived digests found:', archiveError);
  }
} catch (error) {
  console.error('Failed to load digest:', error);
  // Fallback to single card
  academicArtifacts = [
    {
      title: "Weekly Research Roundup",
      description: "Engaging weekly digest of trending research papers with social buzz tracking and editorial analysis.",
      href: "/artifacts/research-roundup",
      icon: "lucide:newspaper",
      status: "active" as const,
      lastUpdated: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
    },
  ];
}

// Load market analysis artifacts
let marketAnalysisArtifacts = [];
try {
  const marketAnalysisPath = path.join(process.cwd(), 'public', 'market-analysis.json');
  const marketAnalysisContent = fs.readFileSync(marketAnalysisPath, 'utf-8');
  const marketAnalysisData = JSON.parse(marketAnalysisContent);
  const digest = marketAnalysisData.data.digest;

  const digestDate = marketAnalysisData.timestamp ? marketAnalysisData.timestamp.split('T')[0] : null;
  const formattedDate = digestDate
    ? new Date(digestDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
    : new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

  // Count crypto and stocks
  const cryptoCount = digest.crypto_section?.items?.length || 0;
  const stocksCount = digest.stocks_section?.items?.length || 0;
  const totalAssets = cryptoCount + stocksCount;

  marketAnalysisArtifacts = [
    {
      title: digest.title || "Market Analysis",
      description: digest.subtitle || "Real-time crypto and stock market analysis with AI-powered insights",
      href: "/artifacts/market-pulse",
      icon: "lucide:trending-up",
      status: "active" as const,
      lastUpdated: formattedDate,
      agents: `${totalAssets} assets tracked`,
    },
  ];
} catch (error) {
  console.log('Market analysis data not found (may not have run yet)');
  marketAnalysisArtifacts = [];
}

// Load news perspectives artifacts
let newsPerspectivesArtifacts = [];
try {
  const perspectivesPath = path.join(process.cwd(), 'public', 'news-perspectives.json');
  const perspectivesContent = fs.readFileSync(perspectivesPath, 'utf-8');
  const perspectivesData = JSON.parse(perspectivesContent);

  const perspectivesDate = perspectivesData.timestamp ? perspectivesData.timestamp.split('T')[0] : null;
  const perspectivesFormattedDate = perspectivesDate
    ? new Date(perspectivesDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
    : new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

  const articlesCount = perspectivesData.data?.count || 0;
  const modelsCount = perspectivesData.data?.models?.length || 4;

  newsPerspectivesArtifacts = [
    {
      title: "AI News Bias Detector",
      description: "Compare how ChatGPT, Llama, and other AIs see the same story - expose bias and think critically",
      href: "/perspectives",
      icon: "lucide:search-check",
      status: "active" as const,
      lastUpdated: perspectivesFormattedDate,
      agents: `${articlesCount} articles × ${modelsCount} AI models`,
    },
  ];
} catch (error) {
  console.log('News perspectives data not found (may not have run yet)');
  newsPerspectivesArtifacts = [];
}

// Organize artifacts by channel
const channels = [
  {
    id: "news-perspectives",
    name: "AI News Bias Detector",
    nameKey: "channel.news.name",
    description: "Compare how ChatGPT, Llama, and other AI models interpret the same story differently - expose AI bias and think critically",
    descKey: "channel.news.description",
    status: newsPerspectivesArtifacts.length > 0 ? "active" as const : "planned" as const,
    artifacts: newsPerspectivesArtifacts,
    meta: {
      schedule: "Every 6 hours",
      scheduleKey: "channel.news.schedule",
      dataSource: "Google News",
      dataSourceKey: "channel.news.source",
      aiTask: "Multi-AI comparison, bias detection, sentiment analysis",
      aiTaskKey: "channel.news.task",
    },
  },
  {
    id: "academic-research",
    name: "Academic Research Channel",
    nameKey: "channel.academic.name",
    description: "Weekly digest of trending research papers with social buzz tracking",
    descKey: "channel.academic.description",
    status: "active" as const,
    artifacts: academicArtifacts,
    meta: {
      schedule: "Weekly (Sundays)",
      scheduleKey: "channel.academic.schedule",
      dataSource: "arXiv API, Twitter/X, Reddit",
      dataSourceKey: "channel.academic.source",
      aiTask: "Paper summarization, trend analysis",
      aiTaskKey: "channel.academic.task",
    },
  },
  {
    id: "market-analysis",
    name: "Market Analysis Channel",
    nameKey: "channel.market.name",
    description: "Real-time crypto and stock market analysis with AI insights",
    descKey: "channel.market.description",
    status: marketAnalysisArtifacts.length > 0 ? "active" as const : "planned" as const,
    artifacts: marketAnalysisArtifacts,
    meta: {
      schedule: marketAnalysisArtifacts.length > 0 ? "Daily (6 AM EST)" : "Daily (6 AM EST)",
      scheduleKey: "channel.market.schedule",
      dataSource: "CoinGecko, Yahoo Finance, News APIs",
      dataSourceKey: "channel.market.source",
      aiTask: "Sentiment analysis, trend prediction",
      aiTaskKey: "channel.market.task",
    },
  },
];
---

<Layout title="Neevs - Automated AI Insights" description="Discover AI-powered channels that analyze news, research, and trends">
    <div class="page-header">
        <h1 class="page-title" data-i18n="home.title">Neevs</h1>
        <p class="page-description" data-i18n="home.subtitle">
            Automated insights from AI-powered channels · Subscribe to what matters
        </p>
        <div class="highlight-badges">
            <span class="highlight-badge">
                <Icon name="lucide:zap" class="badge-icon" />
                <span data-i18n="home.badge.fresh">Always Fresh</span>
            </span>
            <span class="highlight-badge">
                <Icon name="lucide:rocket" class="badge-icon" />
                <span data-i18n="home.badge.automated">Fully Automated</span>
            </span>
            <span class="highlight-badge">
                <Icon name="lucide:sparkles" class="badge-icon" />
                <span data-i18n="home.badge.ai">AI-Powered</span>
            </span>
        </div>
        <p class="page-subdescription" data-i18n="home.subdescription">
            Free to read · Subscribe to channels you love · Built with AgentFlow
        </p>
    </div>

    <h2 class="channels-section-title" data-i18n="home.section.title">Browse All Channels</h2>

    <div class="channels-section">
        {channels.map(channel => (
            <div class="channel-container">
                <div class="channel-header">
                    <div class="channel-title-row">
                        <h2 class="channel-title" data-i18n={channel.nameKey}>{channel.name}</h2>
                        <span class={`channel-status status-${channel.status}`} data-i18n={`home.channel.status.${channel.status}`}>
                            {channel.status}
                        </span>
                    </div>
                    <p class="channel-description" data-i18n={channel.descKey}>{channel.description}</p>

                    {channel.meta && (
                        <div class="channel-meta">
                            <div class="meta-item">
                                <span class="meta-label" data-i18n={channel.status === 'planned' ? 'home.channel.plannedSchedule' : 'home.channel.schedule'}>{channel.status === 'planned' ? 'Planned Schedule:' : 'Schedule:'}</span>
                                <span class="meta-value" data-i18n={channel.meta.scheduleKey}>{channel.meta.schedule}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label" data-i18n="home.channel.dataSource">Data Source:</span>
                                <span class="meta-value" data-i18n={channel.meta.dataSourceKey}>{channel.meta.dataSource}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label" data-i18n="home.channel.aiTask">AI Task:</span>
                                <span class="meta-value" data-i18n={channel.meta.aiTaskKey}>{channel.meta.aiTask}</span>
                            </div>
                        </div>
                    )}
                </div>

                {channel.artifacts.length > 0 ? (
                    <div class="artifacts-container">
                        <div class="artifacts-grid">
                            {channel.artifacts.map(artifact => (
                                <ReportCard {...artifact} />
                            ))}
                        </div>
                    </div>
                ) : (
                    <div class="no-artifacts">
                        <p data-i18n="home.channel.noArtifacts">No artifacts generated yet • Channel coming soon</p>
                    </div>
                )}
            </div>
        ))}
    </div>
</Layout>

<style>
    .page-header {
        text-align: center;
        max-width: 52rem;
        margin: 0 auto var(--space-12);
    }

    .page-title {
        font-size: var(--font-size-4xl);
        font-weight: 700;
        letter-spacing: -0.04em;
        color: var(--color-text-primary);
        margin-bottom: var(--space-3);
    }

    .page-description {
        font-size: var(--font-size-lg);
        color: var(--color-text-secondary);
        font-weight: 400;
        line-height: 1.6;
        margin: 0 0 var(--space-6);
    }

    .highlight-badges {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-2);
        justify-content: center;
        margin-bottom: var(--space-4);
    }

    .highlight-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-2) var(--space-4);
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 1px solid #fbbf24;
        border-radius: var(--radius-full);
        font-size: var(--font-size-sm);
        font-weight: 600;
        color: #92400e;
        box-shadow: 0 2px 4px rgba(251, 191, 36, 0.2);
        transition: all var(--transition-base);
    }

    .badge-icon {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
    }

    .highlight-badge:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(251, 191, 36, 0.3);
    }

    .page-subdescription {
        font-size: var(--font-size-sm);
        color: var(--color-text-tertiary);
        margin: 0;
    }

    /* Channels Section */
    .channels-section-title {
        font-size: var(--font-size-2xl);
        font-weight: 600;
        text-align: center;
        margin-bottom: var(--space-8);
        color: var(--color-text-primary);
        letter-spacing: -0.02em;
        max-width: 72rem;
        margin-left: auto;
        margin-right: auto;
    }

    .channels-section {
        max-width: 72rem;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: var(--space-8);
    }

    .channel-container {
        border: 1px solid var(--color-border-light);
        border-radius: var(--radius-lg);
        padding: var(--space-6);
        background: var(--color-bg-primary);
        transition: all var(--transition-base);
        box-shadow: var(--shadow-sm);
    }

    .channel-container:hover {
        border-color: var(--color-border-medium);
        box-shadow: var(--shadow-md);
    }

    .channel-header {
        margin-bottom: var(--space-4);
    }

    .channel-title-row {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        margin-bottom: var(--space-2);
        flex-wrap: wrap;
    }

    .channel-title {
        font-size: var(--font-size-xl);
        font-weight: 600;
        color: var(--color-text-primary);
        margin: 0;
        letter-spacing: -0.02em;
    }

    .channel-status {
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--font-size-xs);
        font-weight: 500;
        text-transform: capitalize;
    }

    .status-active {
        background: rgba(22, 163, 74, 0.1);
        color: var(--color-accent-success);
    }

    .status-planned {
        background: rgba(156, 163, 175, 0.1);
        color: var(--color-text-tertiary);
    }

    .channel-description {
        font-size: var(--font-size-base);
        color: var(--color-text-secondary);
        margin: 0 0 var(--space-4);
        line-height: 1.5;
    }

    .channel-meta {
        display: flex;
        gap: var(--space-6);
        flex-wrap: wrap;
        padding: var(--space-4);
        background: var(--color-bg-secondary);
        border-radius: var(--radius-md);
        font-size: var(--font-size-sm);
    }

    .meta-item {
        display: flex;
        align-items: baseline;
        gap: var(--space-2);
    }

    .meta-label {
        color: var(--color-text-tertiary);
        font-weight: 500;
    }

    .meta-value {
        color: var(--color-text-primary);
        font-weight: 600;
    }

    .artifacts-container {
        display: flex;
        flex-direction: column;
        gap: var(--space-4);
    }

    .artifacts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: var(--space-4);
    }

    .no-artifacts {
        padding: var(--space-8);
        text-align: center;
        border: 2px dashed var(--color-border-light);
        border-radius: var(--radius-md);
        background: var(--color-bg-secondary);
    }

    .no-artifacts p {
        margin: 0;
        color: var(--color-text-tertiary);
        font-size: var(--font-size-sm);
    }

    @media (max-width: 768px) {
        .page-title {
            font-size: var(--font-size-3xl);
        }

        .page-description {
            font-size: var(--font-size-lg);
        }

        .highlight-badge {
            font-size: var(--font-size-xs);
            padding: var(--space-1) var(--space-3);
        }

        .artifacts-grid {
            grid-template-columns: 1fr;
        }

        .channel-container {
            padding: var(--space-6);
        }

        .channel-meta {
            flex-direction: column;
            gap: var(--space-3);
        }
    }
</style>
