---
import Layout from '../../layouts/Layout.astro';
import { Icon } from 'astro-icon/components';
---

<Layout title="Duke Daily Digest" description="Your daily roundup of what's happening on the Duke campus">
    <article class="digest">
        <div id="content" class="content-wrapper">
            <div class="loading-state">
                <Icon name="lucide:loader-2" class="spinner" />
                <p>Loading today's campus digest...</p>
            </div>
        </div>
    </article>
</Layout>

<style>
    html {
        scroll-behavior: smooth;
    }

    .digest {
        max-width: 800px;
        margin: 0 auto;
    }

    .loading-state {
        text-align: center;
        padding: var(--space-20) var(--space-6);
    }

    .spinner {
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto var(--space-4);
        color: var(--color-accent-primary);
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* Header Styles */
    :global(.digest-header) {
        background: linear-gradient(135deg, #003087, #0736a4);
        color: white;
        padding: var(--space-16) var(--space-8);
        text-align: center;
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-12);
    }

    :global(.digest-title) {
        font-size: var(--font-size-4xl);
        font-weight: 700;
        margin-bottom: var(--space-3);
        line-height: 1.2;
        color: white;
    }

    :global(.digest-subtitle) {
        font-size: var(--font-size-xl);
        opacity: 0.95;
        font-style: italic;
        margin-bottom: var(--space-6);
        color: white;
    }

    :global(.digest-meta) {
        display: flex;
        justify-content: center;
        gap: var(--space-6);
        font-size: var(--font-size-sm);
        opacity: 0.9;
        flex-wrap: wrap;
    }

    /* Intro Box */
    :global(.intro-box) {
        font-size: var(--font-size-lg);
        color: var(--color-text-secondary);
        margin-bottom: var(--space-12);
        padding: var(--space-8);
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border-light);
        border-radius: var(--radius-lg);
        line-height: 1.8;
    }

    /* Sections */
    :global(.category-section) {
        margin-bottom: var(--space-12);
        padding-bottom: var(--space-12);
        border-bottom: 2px solid var(--color-border-light);
    }

    :global(.category-section:last-of-type) {
        border-bottom: none;
    }

    :global(.category-header) {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        margin-bottom: var(--space-4);
    }

    :global(.category-emoji) {
        font-size: var(--font-size-3xl);
    }

    :global(.category-title) {
        font-size: var(--font-size-2xl);
        font-weight: 600;
        color: var(--color-text-primary);
        margin: 0;
    }

    :global(.category-summary) {
        font-size: var(--font-size-base);
        color: var(--color-text-secondary);
        margin-bottom: var(--space-6);
        font-style: italic;
    }

    /* Posts */
    :global(.post-card) {
        padding: var(--space-6);
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-4);
        transition: all 0.2s ease;
    }

    :global(.post-card:hover) {
        border-color: var(--color-accent-primary);
        box-shadow: 0 4px 12px rgba(0, 48, 135, 0.1);
    }

    :global(.post-title) {
        font-size: var(--font-size-lg);
        font-weight: 600;
        color: var(--color-text-primary);
        margin-bottom: var(--space-2);
    }

    :global(.post-summary) {
        color: var(--color-text-secondary);
        margin-bottom: var(--space-3);
        line-height: 1.6;
    }

    :global(.post-meta) {
        display: flex;
        gap: var(--space-4);
        font-size: var(--font-size-sm);
        color: var(--color-text-tertiary);
    }

    :global(.post-meta a) {
        color: var(--color-accent-primary);
        text-decoration: none;
    }

    :global(.post-meta a:hover) {
        text-decoration: underline;
    }

    /* Trending Box */
    :global(.trending-box) {
        background: linear-gradient(135deg, rgba(0, 48, 135, 0.05), rgba(7, 54, 164, 0.05));
        border: 2px solid #003087;
        border-radius: var(--radius-lg);
        padding: var(--space-8);
        margin: var(--space-12) 0;
    }

    :global(.trending-box h3) {
        color: #003087;
        margin-bottom: var(--space-3);
    }

    /* Parting Note */
    :global(.parting-note) {
        text-align: center;
        font-size: var(--font-size-lg);
        color: var(--color-text-secondary);
        padding: var(--space-8);
        font-style: italic;
        margin-top: var(--space-12);
    }

    @media (max-width: 768px) {
        :global(.digest-title) {
            font-size: var(--font-size-3xl);
        }

        :global(.category-title) {
            font-size: var(--font-size-xl);
        }
    }
</style>

<script>
    async function loadDigest() {
        const content = document.getElementById('content');
        if (!content) return;

        const params = new URLSearchParams(window.location.search);
        const timestamp = params.get('timestamp');

        try {
            let digestUrl = timestamp
                ? `/digests/${timestamp}.json`
                : '/duke-local-digest.json';

            const response = await fetch(digestUrl);
            if (!response.ok) throw new Error('Digest not found');

            const data = await response.json();
            content.innerHTML = renderDigest(data.data.digest, timestamp);
        } catch (error) {
            console.error('Error loading digest:', error);
            content.innerHTML = `
                <div style="text-align: center; padding: var(--space-16);">
                    <p style="color: var(--color-text-secondary); margin-bottom: var(--space-4);">
                        No digest available yet. Check back later!
                    </p>
                    <a href="/" style="color: var(--color-accent-primary);">‚Üê Back to Home</a>
                </div>
            `;
        }
    }

    function renderDigest(digest: any, archiveTimestamp: string | null = null) {
        const currentDate = new Date().toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        let html = '';

        // Back to latest if viewing archive
        if (archiveTimestamp) {
            html += `
                <div style="margin-bottom: var(--space-6); text-align: center;">
                    <a href="/artifacts/duke-daily" style="color: var(--color-accent-primary); text-decoration: none; font-weight: 600;">
                        ‚Üê Back to Latest Digest
                    </a>
                </div>
            `;
        }

        html += `
            <header class="digest-header">
                <h1 class="digest-title">${digest.title}</h1>
                <p class="digest-subtitle">${digest.subtitle}</p>
                <div class="digest-meta">
                    <span>üìÖ ${currentDate}</span>
                    <span>üéì r/duke</span>
                    <span>ü§ñ AI-Curated</span>
                </div>
            </header>

            <div class="intro-box">
                ${digest.intro}
            </div>
        `;

        // Trending Now
        if (digest.trending_now) {
            html += `
                <div class="trending-box">
                    <h3>üî• Trending Now</h3>
                    <p><strong>${digest.trending_now.post_title}</strong></p>
                    <p style="color: var(--color-text-secondary); margin-top: var(--space-2);">
                        ${digest.trending_now.reason}
                    </p>
                </div>
            `;
        }

        // Sections
        for (const section of digest.sections || []) {
            html += `
                <section class="category-section">
                    <div class="category-header">
                        <span class="category-emoji">${section.emoji || 'üìå'}</span>
                        <h2 class="category-title">${section.category}</h2>
                    </div>
                    <p class="category-summary">${section.summary}</p>
            `;

            // Posts in this category
            for (const post of section.posts_data || []) {
                html += `
                    <div class="post-card">
                        <h3 class="post-title">${post.title}</h3>
                        <p class="post-summary">${post.summary || post.why_notable || ''}</p>
                        <div class="post-meta">
                            <span>üëç ${post.upvotes || 0} upvotes</span>
                            <span>üí¨ ${post.num_comments || 0} comments</span>
                            ${post.url ? `<a href="${post.url}" target="_blank">View on Reddit ‚Üí</a>` : ''}
                        </div>
                    </div>
                `;
            }

            html += `</section>`;
        }

        // Quick Hits
        if (digest.quick_hits && digest.quick_hits.length > 0) {
            html += `
                <div style="margin: var(--space-8) 0; padding: var(--space-6); background: var(--color-bg-secondary); border-radius: var(--radius-md);">
                    <h3 style="margin-bottom: var(--space-3);">Quick Hits</h3>
                    <ul style="margin: 0; padding-left: var(--space-6);">
            `;
            for (const hit of digest.quick_hits) {
                html += `<li style="margin-bottom: var(--space-2);">${hit}</li>`;
            }
            html += `</ul></div>`;
        }

        // Parting Note
        html += `
            <div class="parting-note">
                ${digest.parting_note || "Stay connected, Blue Devils!"}
            </div>
        `;

        return html;
    }

    // Load digest when page loads
    loadDigest();
</script>
