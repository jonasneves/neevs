name: Reusable Agent Runner

on:
  workflow_call:
    inputs:
      agent_module:
        description: 'Python module path for the agent (e.g., agents.academic_research.arxiv_fetcher)'
        required: true
        type: string
      agent_id:
        description: 'Agent ID for log files (e.g., agent-a)'
        required: true
        type: string
      python_deps:
        description: 'Python dependencies to install (space-separated)'
        required: false
        type: string
        default: ''
      needs_openai:
        description: 'Whether this agent needs OpenAI API access'
        required: false
        type: boolean
        default: false
      extra_env:
        description: 'Additional environment variables (KEY=value format, one per line)'
        required: false
        type: string
        default: ''
    secrets:
      OPENAI_API_KEY:
        required: false
      ALPHA_VANTAGE_API_KEY:
        required: false
      GH_MODELS_TOKEN:
        required: false

jobs:
  run-agent:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Pull latest changes
        run: git pull origin ${{ github.ref_name }} || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        if: inputs.python_deps != ''
        run: pip install ${{ inputs.python_deps }}

      - name: Set custom environment variables
        if: inputs.extra_env != ''
        run: |
          echo "Setting additional environment variables..."
          echo "${{ inputs.extra_env }}" >> $GITHUB_ENV

      - name: Run Agent
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY }}
          GH_MODELS_TOKEN: ${{ secrets.GH_MODELS_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_MODELS_TOKEN }}
        run: |
          python -m ${{ inputs.agent_module }} 2>&1 | tee ${{ inputs.agent_id }}-execution.log

      - name: Commit and push results
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/
          git diff --staged --quiet || git commit -m "${{ inputs.agent_id }}: Updated - $(date -u +%Y-%m-%dT%H:%M:%SZ)"

          # Push with retry and rebase on conflict
          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "Push attempt $attempt of $max_attempts"
            if git push; then
              echo "✓ Push successful"
              break
            else
              if [ $attempt -lt $max_attempts ]; then
                echo "Push failed, pulling and rebasing..."
                # Use --autostash to automatically stash/unstash uncommitted changes
                git pull --rebase --autostash origin ${{ github.ref_name }}
                attempt=$((attempt + 1))
              else
                echo "✗ Push failed after $max_attempts attempts"
                exit 1
              fi
            fi
          done
